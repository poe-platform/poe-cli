<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poe Code - Browser Preview</title>
    <style>
        /* Reuse exact styles from extension.ts getWebviewContent() */
        :root {
            --sidebar-width: 240px;
            /* VSCode theme variables - fallback to light theme */
            --vscode-editor-background: #ffffff;
            --vscode-editor-foreground: #000000;
            --vscode-sideBar-background: #f3f3f3;
            --vscode-panel-border: #e0e0e0;
            --vscode-foreground: #000000;
            --vscode-button-background: #007acc;
            --vscode-button-foreground: #ffffff;
            --vscode-button-hoverBackground: #005a9e;
            --vscode-button-border: transparent;
            --vscode-button-secondaryBackground: #5f6a79;
            --vscode-button-secondaryForeground: #ffffff;
            --vscode-input-background: #ffffff;
            --vscode-input-foreground: #000000;
            --vscode-input-border: #cecece;
            --vscode-list-hoverBackground: #e8e8e8;
            --vscode-list-activeSelectionBackground: #0060c0;
            --vscode-list-activeSelectionForeground: #ffffff;
            --vscode-badge-background: #007acc;
            --vscode-badge-foreground: #ffffff;
            --vscode-descriptionForeground: #717171;
            --vscode-textBlockQuote-background: #f8f8f8;
            --vscode-textBlockQuote-border: #007acc;
            --vscode-editorWidget-background: #f3f3f3;
            --vscode-editorHoverWidget-background: #f3f3f3;
            --vscode-editorHoverWidget-foreground: #000000;
            --vscode-focusBorder: #007acc;
            --vscode-editor-font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            --vscode-editor-inactiveSelectionBackground: #e5ebf1;
        }

        /* VSCode Dark+ theme (actual colors) */
        @media (prefers-color-scheme: dark) {
            :root {
                --vscode-editor-background: #1e1e1e;
                --vscode-editor-foreground: #cccccc;
                --vscode-sideBar-background: #252526;
                --vscode-panel-border: #2b2b2b;
                --vscode-foreground: #cccccc;
                --vscode-button-background: #0e639c;
                --vscode-button-foreground: #ffffff;
                --vscode-button-hoverBackground: #1177bb;
                --vscode-button-border: transparent;
                --vscode-button-secondaryBackground: #3a3d41;
                --vscode-button-secondaryForeground: #cccccc;
                --vscode-input-background: #3c3c3c;
                --vscode-input-foreground: #cccccc;
                --vscode-input-border: #3c3c3c;
                --vscode-list-hoverBackground: #2a2d2e;
                --vscode-list-activeSelectionBackground: #04395e;
                --vscode-list-activeSelectionForeground: #ffffff;
                --vscode-badge-background: #4d4d4d;
                --vscode-badge-foreground: #ffffff;
                --vscode-descriptionForeground: #717171;
                --vscode-textBlockQuote-background: #222222;
                --vscode-textBlockQuote-border: #007acc;
                --vscode-editorWidget-background: #252526;
                --vscode-editorHoverWidget-background: #252526;
                --vscode-editorHoverWidget-foreground: #cccccc;
                --vscode-focusBorder: #007fd4;
                --vscode-editor-inactiveSelectionBackground: #3a3d41;
                --vscode-editor-font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
        }

        .poe-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
            background-color: var(--vscode-editor-background);
        }

        .app-header .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--vscode-foreground);
        }

        .app-header img {
            width: 20px;
            height: 20px;
        }

        .app-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-nav button {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--vscode-button-border);
            background: transparent;
            color: var(--vscode-foreground);
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s ease;
        }

        .app-nav button:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .model-list {
            display: none;
        }

        .model-item {
            display: none;
        }

        .main-pane {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
            background-color: var(--vscode-editor-background);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 999px;
            background-color: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
        }

        .strategy-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 999px;
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            opacity: 0.8;
        }

        .chat-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            scroll-behavior: smooth;
        }

        #messages {
            max-width: 900px;
            margin: 0 auto;
        }

        .message-wrapper {
            margin-bottom: 16px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--vscode-descriptionForeground);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--vscode-button-background);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--vscode-button-foreground);
            font-size: 10px;
            font-weight: 600;
            overflow: hidden;
        }

        .avatar.assistant {
            background: transparent;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            padding: 12px;
            border-radius: 8px;
            line-height: 1.5;
            font-size: 12px;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            overflow-x: auto;
        }

        .message-wrapper.assistant .message-content {
            background-color: var(--vscode-textBlockQuote-background);
            border-left: 3px solid var(--vscode-textBlockQuote-border);
        }

        .message-content pre {
            padding: 10px;
            background-color: var(--vscode-editor-background);
            border-radius: 6px;
            overflow: auto;
            font-size: 11px;
        }

        .message-content code {
            background-color: var(--vscode-editor-background);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: var(--vscode-editor-font-family, monospace);
            font-size: 11px;
        }

        .thinking {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--vscode-descriptionForeground);
            margin-top: 16px;
        }

        .thinking.hidden {
            display: none;
        }

        .thinking-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--vscode-descriptionForeground);
            animation: thinking 1s ease-in-out infinite;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinking {
            0%, 80%, 100% {
                opacity: 0.2;
            }
            40% {
                opacity: 1;
            }
        }

        .composer {
            padding: 12px 16px;
            border-top: 1px solid var(--vscode-panel-border);
            background-color: var(--vscode-editor-background);
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        #message-input {
            flex: 1;
            min-height: 60px;
            max-height: 180px;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }

        .composer-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .composer-button {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--vscode-button-border);
            background: transparent;
            color: var(--vscode-foreground);
            cursor: pointer;
            font-size: 11px;
        }

        .composer-button.primary {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .composer-button.primary:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .settings-panel {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: flex-end;
            background-color: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(2px);
            padding: 24px;
            z-index: 200;
        }

        .settings-content {
            width: 320px;
            max-width: 100%;
            background-color: var(--vscode-editorWidget-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.35);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h3 {
            margin: 0;
            font-size: 13px;
        }

        .settings-section h4 {
            margin: 0 0 10px 0;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--vscode-descriptionForeground);
        }

        .provider-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .provider-item {
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid var(--vscode-panel-border);
            background-color: var(--vscode-editor-background);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .provider-item.active {
            border-color: var(--vscode-focusBorder);
            box-shadow: 0 0 0 1px var(--vscode-focusBorder);
        }

        .provider-item strong {
            font-size: 11px;
        }

        .provider-item span {
            font-size: 10px;
            color: var(--vscode-descriptionForeground);
        }

        .provider-empty {
            font-size: 10px;
            color: var(--vscode-descriptionForeground);
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
        }

        .message-wrapper.diff {
            background-color: var(--vscode-editorWidget-background);
            border: 1px solid var(--vscode-panel-border);
        }

        .message-wrapper.diff .message-content {
            background-color: transparent;
            border: none;
            padding: 0;
        }

        .diff-preview {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .diff-preview .diff-header {
            font-weight: 600;
            font-size: 13px;
            color: var(--vscode-foreground);
        }

        .diff-preview .diff-body {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-family: var(--vscode-editor-font-family, monospace);
            font-size: 13px;
        }

        .diff-row {
            display: block;
        }

        .diff-row code {
            display: block;
            padding: 4px 6px;
            border-radius: 4px;
            background-color: transparent;
            white-space: pre-wrap;
        }

        .diff-added {
            background-color: rgba(46, 204, 113, 0.16);
            color: var(--vscode-foreground);
        }

        .diff-removed {
            background-color: rgba(231, 76, 60, 0.16);
            color: var(--vscode-foreground);
        }

        .diff-context {
            color: var(--vscode-descriptionForeground);
        }

        .tool-notifications {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .tool-notification {
            padding: 10px 14px;
            border-radius: 6px;
            background-color: var(--vscode-editorHoverWidget-background);
            color: var(--vscode-editorHoverWidget-foreground);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
            border-left: 3px solid transparent;
            opacity: 0.95;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .tool-notification.running {
            border-left-color: #0984e3;
        }

        .tool-notification.success {
            border-left-color: #2ecc71;
        }

        .tool-notification.error {
            border-left-color: #d63031;
        }

        .tool-notification.fade {
            opacity: 0;
            transform: translateY(10px);
        }

        .welcome-message {
            text-align: center;
            padding: 24px;
            background-color: var(--vscode-editor-background);
            border: 1px dashed var(--vscode-panel-border);
            border-radius: 8px;
            margin-top: 24px;
        }

        .welcome-message h2 {
            margin-bottom: 6px;
            font-size: 14px;
        }

        .welcome-message p {
            margin: 0;
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
        }

        .chat-history {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            background-color: var(--vscode-editor-background);
            z-index: 300;
        }

        .chat-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .chat-history-header h3 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
        }

        .chat-history-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .chat-history-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .chat-history-item:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .chat-history-item-title {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chat-history-item-preview {
            font-size: 10px;
            color: var(--vscode-descriptionForeground);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-history-empty {
            text-align: center;
            padding: 32px;
            color: var(--vscode-descriptionForeground);
            font-size: 11px;
        }

        .hidden {
            display: none !important;
        }

        .connection-status {
            padding: 8px 12px;
            background: #f39c12;
            color: white;
            text-align: center;
            font-size: 13px;
        }

        .connection-status.connected {
            background: #27ae60;
        }

        .connection-status.error {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div id="connection-status" class="connection-status">Connecting to server...</div>
    <div class="poe-layout">
        <header class="app-header" data-slot="app-shell">
            <!-- Will be populated by renderAppShell -->
        </header>
        <main class="main-pane">
            <header class="status-bar">
                <div class="status-left">
                    <span id="model-badge" class="model-badge">Loading...</span>
                    <span id="strategy-badge" class="strategy-badge">No Strategy</span>
                </div>
                <div id="model-selector" data-slot="model-selector"></div>
            </header>
            <section id="chat-container" class="chat-scroll">
                <div id="messages">
                    <div class="welcome-message">
                        <h2>Welcome to Poe Code Browser Preview</h2>
                        <p>Start chatting with Poe models. This is running outside VSCode!</p>
                    </div>
                </div>
                <div id="thinking-indicator" class="thinking hidden">
                    <span class="thinking-dot"></span>
                    <span class="thinking-dot"></span>
                    <span class="thinking-dot"></span>
                    <span>Thinking...</span>
                </div>
            </section>
            <footer class="composer">
                <textarea id="message-input" placeholder="Ask Poe…" rows="1"></textarea>
                <div class="composer-actions">
                    <button id="clear-button" type="button" class="composer-button">Clear</button>
                    <button id="send-button" type="button" class="composer-button primary">Send</button>
                </div>
            </footer>
            <section id="settings-panel" class="settings-panel hidden">
                <div class="settings-content">
                    <header class="settings-header">
                        <h3>Settings</h3>
                        <button type="button" class="composer-button" data-action="settings-close">Close</button>
                    </header>
                    <div class="settings-section">
                        <h4>Providers</h4>
                        <div id="provider-settings" class="provider-list"></div>
                    </div>
                    <div class="settings-actions">
                        <button type="button" class="composer-button" data-action="settings-open-mcp">
                            Open MCP Configuration
                        </button>
                    </div>
                </div>
            </section>
            <section id="chat-history" class="chat-history hidden">
                <div class="chat-history-header">
                    <h3>Chat History</h3>
                    <button type="button" class="composer-button" data-action="history-close">Close</button>
                </div>
                <div class="chat-history-content">
                    <div class="chat-history-empty">No chat history available yet.</div>
                </div>
            </section>
            <div id="tool-notifications" class="tool-notifications"></div>
        </main>
    </div>

    <!-- Load compiled webview modules as bundle -->
    <script src="/api/webview-bundle.js"></script>
    <script>
        // Functions are now available on window from the bundle
        const { initializeWebviewApp, renderAppShell, renderModelSelector } = window;

        // WebSocket connection to backend
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = message;
            statusEl.className = `connection-status ${status}`;
            
            if (status === 'connected') {
                setTimeout(() => statusEl.style.display = 'none', 2000);
            } else {
                statusEl.style.display = 'block';
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('✅ Connected to preview server');
                reconnectAttempts = 0;
                updateConnectionStatus('connected', '✓ Connected to server');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                
                if (message.type === 'connected') {
                    console.log('Server connection established:', message);
                    // Initialize the app with server data
                    initializeApp(message);
                } else {
                    // Forward all other messages to the webview app
                    window.dispatchEvent(new MessageEvent('message', { data: message }));
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('error', '✗ Connection error');
            };

            ws.onclose = () => {
                console.log('WebSocket closed');
                updateConnectionStatus('error', '✗ Disconnected from server');
                
                // Attempt to reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                    console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(connectWebSocket, delay);
                }
            };
        }

        // Mock VSCode API that communicates with backend via WebSocket
        function acquireVsCodeApi() {
            return {
                postMessage(message) {
                    console.log('📤 [Mock VSCode] Sending:', message);
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify(message));
                    } else {
                        console.error('WebSocket not connected');
                        updateConnectionStatus('error', '✗ Not connected to server');
                    }
                },
                setState(state) {
                    sessionStorage.setItem('vscode-state', JSON.stringify(state));
                },
                getState() {
                    const stored = sessionStorage.getItem('vscode-state');
                    return stored ? JSON.parse(stored) : undefined;
                }
            };
        }

        // Make it globally available
        window.acquireVsCodeApi = acquireVsCodeApi;

        async function initializeApp(serverData) {
            const { defaultModel, availableTools } = serverData;
            
            // Fetch provider settings from server
            const providersResponse = await fetch('/api/providers');
            const providerSettings = await providersResponse.json();

            const logoUrl = '/assets/poe-bw.svg';
            const models = [defaultModel, ...providerSettings.map(p => p.label)];

            const appShellHtml = renderAppShell({
                logoUrl,
                models,
                activeModel: defaultModel
            });

            const modelSelectorHtml = renderModelSelector({
                models,
                selected: defaultModel
            });

            // Initialize the webview app (reuses existing runtime.ts code)
            const app = initializeWebviewApp({
                document,
                appShellHtml,
                modelSelectorHtml,
                providerSettings,
                defaultModel,
                logoUrl,
                postMessage: (message) => {
                    const vscode = acquireVsCodeApi();
                    vscode.postMessage(message);
                }
            });

            // Listen for messages from server
            window.addEventListener('message', (event) => {
                app.handleMessage(event.data);
            });

            // Request initial strategy status
            const vscode = acquireVsCodeApi();
            vscode.postMessage({ type: 'getStrategyStatus' });

            console.log('✅ Webview app initialized');
        }

        // Start connection
        connectWebSocket();
    </script>
</body>
</html>